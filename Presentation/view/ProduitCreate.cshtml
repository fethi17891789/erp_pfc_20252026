@page
@model erppfc20252026.Pages.ProduitsModel
@{
    ViewData["Title"] = "Produits";
}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/Common.css">
<link rel="stylesheet" href="/css/Home.css">

<div class="erp-shell">
    <!-- BARRE LATÉRALE GAUCHE (identique) -->
    <aside class="erp-sidebar">
        <div class="erp-logo">
            <span class="erp-logo-mark">E</span>
            <span class="erp-logo-text">ERP Suite</span>
        </div>
        <nav class="erp-nav">
            <a asp-page="/Home" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                    <polyline points="9 22 9 12 15 12 15 22" />
                </svg>
                <span>Accueil</span>
            </a>
            <a asp-page="/Fabrication" class="nav-item nav-item-active">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9h12M6 12h12M6 15h12M3 3h18a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" />
                </svg>
                <span>Modules</span>
            </a>
            <button class="nav-item" type="button">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 1-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
                <span>Profils</span>
            </button>
            <button class="nav-item" type="button">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" />
                    <rect x="14" y="3" width="7" height="7" />
                    <rect x="14" y="14" width="7" height="7" />
                    <rect x="3" y="14" width="7" height="7" />
                </svg>
                <span>Bases ERP</span>
            </button>
            <button class="nav-item" type="button">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1" />
                    <path d="M12 1v6m6.07 6.07h-6.14M12 19v4m6.07-6.07v0" />
                    <path d="M19 5l-4.24 4.24M5 19l4.24-4.24" />
                    <path d="M19 19l-4.24-4.24M5 5l4.24 4.24" />
                </svg>
                <span>Paramètres</span>
            </button>
        </nav>
        <div class="erp-sidebar-footer">
            <button class="sidebar-quick" type="button">
                <svg style="width: 14px; height: 14px; display: inline-block; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="15" x2="12" y2="21" />
                    <line x1="15" y1="11" x2="21" y2="12" />
                </svg>
                Nouveau profil
            </button>
            <button class="sidebar-quick secondary" type="button" onclick="openLogoutModal()">
                <svg style="width: 14px; height: 14px; display: inline-block; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 3 16 10 13 7" />
                    <path d="M16 10v7a2 2 0 0 1-2 2h-2" />
                </svg>
                Déconnexion
            </button>
        </div>
    </aside>

    <!-- CONTENU PRINCIPAL -->
    <main class="erp-main">
        <header class="erp-header">
            <div class="header-left">
                <h1>Produits</h1>
                <p>Créer et administrer les fiches produits.</p>
            </div>
            <div class="header-right">
                <div class="header-db">
                    <span class="header-db-label">Base active</span>
                    <span class="header-db-name">erpdb</span>
                </div>
                <button class="header-btn" type="button">
                    <svg style="width: 14px; height: 14px; display: inline-block; margin-right: 4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6" />
                        <path d="M23 20v-6h-6" />
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64" />
                        <path d="M3.51 15A9 9 0 0 0 18.36 18.36" />
                    </svg>
                    Changer de base
                </button>
                <button class="header-profile-btn" type="button">
                    <div class="header-avatar">P</div>
                </button>
            </div>
        </header>

        <section class="erp-content">
            <!-- Toolbar -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px;">
                <div style="flex:1; display:flex; justify-content:center;">
                    <div class="job-input-wrapper" style="max-width:420px; width:100%;">
                        <input type="text" class="job-input" placeholder="Rechercher un produit..." onkeyup="filterProducts(this.value)">
                        <span class="job-input-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px; height:14px;">
                                <circle cx="11" cy="11" r="6"></circle>
                                <line x1="16" y1="16" x2="20" y2="20"></line>
                            </svg>
                        </span>
                    </div>
                </div>
                <div style="margin-left:16px;">
                    <a asp-page="/ProduitNew"
                       class="sidebar-quick"
                       style="display:inline-flex; align-items:center; gap:6px; padding-inline:16px; text-decoration:none;">
                        <span>Créer produit</span>
                        <span style="font-size:16px; line-height:1">+</span>
                    </a>
                </div>
            </div>

            <!-- GRILLE PRODUITS -->
            <div id="productsContainer"
                 style="display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:16px; max-height:70vh; overflow-y:auto; padding-right:8px;">
                @if (Model.Produits != null && Model.Produits.Any())
                {
                    @foreach (var produit in Model.Produits)
                    {
                        <div class="form-group product-item" data-ref="@produit.Reference" style="margin:0; position:relative;">
                            <div class="product-card"
                                 style="
                                            padding:12px 12px;
                                            background:linear-gradient(135deg, rgba(8,11,32,0.96), rgba(18,22,54,0.96));
                                            border:1px solid var(--border-soft);
                                            border-radius:var(--radius-sm);
                                            display:flex;
                                            flex-direction:column;
                                            gap:8px;
                                            transition:border-color 140ms cubic-bezier(0.2,0.8,0.2,1),
                                                       box-shadow 140ms cubic-bezier(0.2,0.8,0.2,1),
                                                       transform 80ms ease-out,
                                                       background 140ms cubic-bezier(0.2,0.8,0.2,1);
                                         "
                                 onmouseover="this.style.borderColor='var(--accent-glow)'; this.style.boxShadow='0 14px 40px rgba(123,94,255,0.35)'; this.style.transform='translateY(-2px)'; this.style.background='linear-gradient(135deg, rgba(15,18,48,1), rgba(25,30,70,1))';"
                                 onmouseout="this.style.borderColor='var(--border-soft)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'; this.style.background='linear-gradient(135deg, rgba(8,11,32,0.96), rgba(18,22,54,0.96))';">
                                <div class="product-card-header">
                                    @{
                                        var hasImage = !string.IsNullOrWhiteSpace(produit.Image);
                                        var thumbUrl = hasImage ? Url.Content("~/images/produits/" + produit.Image) : "";
                                    }

                                    <!-- IMAGE CLIQUABLE, HORS DU LIEN -->
                                    <div style="width:80px; height:100px; border-radius:14px; overflow:hidden; border:1px solid rgba(148,163,184,0.5); background:#020617; flex-shrink:0; display:flex; align-items:center; justify-content:center; cursor:pointer;"
                                         onclick="openProductImageModal('@thumbUrl'); event.stopPropagation();">
                                        @if (hasImage)
                                        {
                                            <img src="@thumbUrl"
                                                 alt="Image @produit.Nom"
                                                 style="max-width:100%; max-height:100%; object-fit:cover;" />
                                        }
                                        else
                                        {
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:24px; height:24px; color:rgba(148,163,184,0.8);">
                                                <rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect>
                                                <circle cx="9" cy="11" r="2"></circle>
                                                <path d="M21 17l-5-5-3 3-2-2-5 4"></path>
                                            </svg>
                                        }
                                    </div>

                                    <!-- TEXTE CLIQUABLE (LIEN VERS ProduitNew) -->
                                    <a asp-page="/ProduitNew" asp-route-id="@produit.Id" style="text-decoration:none; color:inherit; flex:1; min-width:0;">
                                        <div class="product-card-text">
                                            <div class="product-card-title">
                                                @produit.Nom
                                            </div>
                                            <div class="product-card-subtitle">
                                                REF: @produit.Reference
                                            </div>
                                            <div class="product-card-price">
                                                <span class="product-card-price-label">Prix :</span>
                                                <span>@produit.PrixVente.ToString("N2") DA</span>
                                            </div>
                                            <!-- NOUVEAU : stock disponible -->
                                            <div class="product-card-stock" style="font-size:0.8rem; color:var(--text-muted); margin-top:2px;">
                                                Stock : @produit.QuantiteDisponible
                                            </div>
                                        </div>
                                    </a>

                                    <!-- Bouton menu ⋮ séparé du lien -->
                                    <div style="position:relative;">
                                        <button type="button"
                                                class="btn-icon"
                                                onclick="toggleProductMenu(event, '@produit.Id')"
                                                style="border:none; background:transparent; color:var(--text-muted); cursor:pointer; padding:4px;">
                                            ⋮
                                        </button>
                                        <div id="product-menu-@produit.Id"
                                             class="product-menu"
                                             style="display:none; position:absolute; right:0; top:24px; background:#111628; border:1px solid var(--border-soft); border-radius:6px; min-width:140px; z-index:20; box-shadow:0 10px 30px rgba(0,0,0,0.4);">
                                            <button type="button"
                                                    onclick="openDeleteModal(event, @produit.Id)"
                                                    style="width:100%; text-align:left; padding:8px 10px; background:transparent; border:none; color:#f97373; font-size:0.8rem; cursor:pointer;">
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div style="grid-column:1/-1; text-align:center; padding:60px 20px; color:var(--text-muted);">
                        <div style="display:inline-flex; align-items:center; justify-content:center; width:72px; height:72px; border-radius:24px; background:rgba(15,23,42,0.9); border:1px solid rgba(148,163,184,0.35); margin-bottom:20px; box-shadow:0 18px 40px rgba(15,23,42,0.7);">
                            <svg viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor"
                                 stroke-width="1.8"
                                 style="width:38px; height:38px; color:var(--accent);">
                                <path d="M3 7.5L12 3l9 4.5v9L12 21l-9-4.5v-9z"></path>
                                <path d="M12 21v-9"></path>
                                <path d="M3 7.5l9 4.5 9-4.5"></path>
                                <path d="M8 5.6l8 4"></path>
                            </svg>
                        </div>

                        <div style="font-size:1.3rem; font-weight:700; color:var(--text); margin-bottom:8px;">
                            Aucun produit
                        </div>
                        <div style="font-size:0.95rem; margin-bottom:24px;">
                            Commencez par créer votre premier produit.
                        </div>
                        <a asp-page="/ProduitNew" class="btn-secondary" style="display:inline-block; padding:12px 24px;">
                            Créer un produit
                        </a>
                    </div>
                }
            </div>
        </section>
    </main>
</div>

<!-- POPUP DÉCONNEXION -->
<div id="logout-overlay" class="logout-overlay" style="display:none;">
    <div class="logout-modal">
        <h3>Confirmer la déconnexion</h3>
        <p>Voulez-vous vraiment vous déconnecter et revenir à l'écran de choix du profil ?</p>
        <form method="post" asp-page-handler="Logout">
            <div class="logout-modal-actions">
                <button type="button" class="btn-secondary" onclick="closeLogoutModal()">Non, rester</button>
                <button type="submit" class="btn-primary">Oui, se déconnecter</button>
            </div>
        </form>
    </div>
</div>

<!-- POPUP SUPPRESSION PRODUIT -->
<div id="delete-overlay" class="logout-overlay" style="display:none;">
    <div class="logout-modal">
        <h3>Supprimer ce produit</h3>
        <p>Voulez-vous vraiment supprimer ce produit ? Cette action est irréversible.</p>

        <form method="post"
              asp-page-handler="Delete"
              id="delete-product-form">
            <input type="hidden" name="id" id="delete-product-id" />

            <div class="logout-modal-actions">
                <button type="button"
                        class="btn-secondary"
                        onclick="closeDeleteModal()">
                    Non, annuler
                </button>
                <button type="submit"
                        class="btn-primary">
                    Oui, supprimer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL APERÇU GRANDE IMAGE (liste produits) -->
<div id="image-modal-overlay" class="logout-overlay" style="display:none; background:rgba(3,6,23,0.8);">
    <div class="logout-modal" style="max-width:520px; width:90%; padding:12px 12px 16px 12px;">
        <h3 style="margin-bottom:10px;">Image du produit</h3>
        <div style="border-radius:16px; overflow:hidden; border:1px solid var(--border-soft); background:#020617; max-height:70vh; display:flex; align-items:center; justify-content:center;">
            <img id="image-modal-img"
                 src=""
                 alt="Image produit"
                 style="max-width:100%; max-height:70vh; object-fit:contain;" />
        </div>
        <div class="logout-modal-actions" style="margin-top:12px;">
            <button type="button" class="btn-primary" onclick="document.getElementById('image-modal-overlay').style.display='none'">Fermer</button>
        </div>
    </div>
</div>

<script src="/js/Home.js"></script>
<script>
    function filterProducts(searchTerm) {
        const container = document.getElementById('productsContainer');
        const items = container.querySelectorAll('.product-item');

        items.forEach(item => {
            const ref = (item.dataset.ref || '').toLowerCase();
            const nameEl = item.querySelector('.product-card-title');
            const name = nameEl ? nameEl.textContent.toLowerCase() : '';
            if (ref.includes(searchTerm.toLowerCase()) || name.includes(searchTerm.toLowerCase())) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function toggleProductMenu(event, id) {
        event.preventDefault();
        event.stopPropagation();

        const menu = document.getElementById('product-menu-' + id);
        const isVisible = menu.style.display === 'block';

        document.querySelectorAll('.product-menu').forEach(m => m.style.display = 'none');

        menu.style.display = isVisible ? 'none' : 'block';
    }

    document.addEventListener('click', function () {
        document.querySelectorAll('.product-menu').forEach(m => m.style.display = 'none');
        document.getElementById('delete-overlay').style.display = 'none';
    });

    function openDeleteModal(event, id) {
        event.preventDefault();
        event.stopPropagation();

        document.querySelectorAll('.product-menu').forEach(m => m.style.display = 'none');

        const idInput = document.getElementById('delete-product-id');
        idInput.value = id;

        document.getElementById('delete-overlay').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('delete-overlay').style.display = 'none';
    }

    function openLogoutModal() {
        document.getElementById('logout-overlay').style.display = 'flex';
    }

    function closeLogoutModal() {
        document.getElementById('logout-overlay').style.display = 'none';
    }

    function openProductImageModal(url) {
        if (!url) return;
        const overlay = document.getElementById('image-modal-overlay');
        const img = document.getElementById('image-modal-img');
        if (!overlay || !img) return;
        img.src = url;
        overlay.style.display = 'flex';
    }
</script>
